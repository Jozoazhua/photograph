# Photograph 架构设计文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                          Photograph 应用架构                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌──────────────┐  │
│  │   GUI 层        │    │   业务逻辑层     │    │   数据层     │  │
│  │                 │    │                 │    │              │  │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌──────────┐ │  │
│  │ │GalleryCrawler│ │    │ │APIManager   │ │    │ │WebScraper│ │  │
│  │ │(主窗口)      │ │    │ │(API管理器)  │ │    │ │(爬虫核心)│ │  │
│  │ └─────────────┘ │    │ └─────────────┘ │    │ └──────────┘ │  │
│  │                 │    │                 │    │              │  │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌──────────┐ │  │
│  │ │ThumbnailWidget│ │    │ │ImageDownload│ │    │ │HTTP      │ │  │
│  │ │(缩略图组件)  │ │    │ │Manager      │ │    │ │Session   │ │  │
│  │ └─────────────┘ │    │ │(下载管理器) │ │    │ └──────────┘ │  │
│  │                 │    │ └─────────────┘ │    │              │  │
│  │ ┌─────────────┐ │    │                 │    │              │  │
│  │ │Preview      │ │    │                 │    │              │  │
│  │ │Components   │ │    │                 │    │              │  │
│  │ └─────────────┘ │    │                 │    │              │  │
│  └─────────────────┘    └─────────────────┘    └──────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                         多线程工作层                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │
│  │SearchWorker │  │PageFetch    │  │Download     │  │Thumbnail │ │
│  │(搜索线程)   │  │Worker       │  │Worker       │  │Worker    │ │
│  │             │  │(页面获取)   │  │(下载线程)   │  │(缩略图)  │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └──────────┘ │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │
│  │ImageLoad    │  │Gallery      │  │AllPagesFetch│  │FileDown  │ │
│  │Worker       │  │Worker       │  │Worker       │  │Worker    │ │
│  │(图片加载)   │  │(图片集处理) │  │(全页获取)   │  │(文件下载)│ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └──────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 类关系图

```
BaseWorker (QThread)
├── ImageLoadWorker
├── SearchWorker
├── PageFetchWorker
├── AllPagesFetchWorker
├── GalleryWorker
├── ThumbnailWorker
└── DownloadWorker

QObject
├── APIManager
└── ImageDownloadManager

QThread
└── FileDownloadWorker

QWidget
└── GalleryCrawler

QFrame
├── ThumbnailWidget
└── PreviewItemWidget

QDialog
├── OriginalImageViewer
└── ThumbnailViewerDialog

静态类
└── WebScraper
```

## 数据流图

```
用户操作 → GUI界面 → 业务逻辑 → 工作线程 → 网络请求 → 数据解析 → 结果返回
    ↓                                                          ↑
    └─────────────────── 信号槽通信 ←──────────────────────────┘
```

## 核心组件详解

### 1. GUI层组件

#### GalleryCrawler (主窗口)
- **职责**: 主界面管理，事件协调
- **主要功能**:
  - 管理标签页切换
  - 处理用户交互
  - 协调各个功能模块
  - 状态显示和更新

#### ThumbnailWidget (缩略图组件)
- **职责**: 显示单个图片集的缩略图
- **主要功能**:
  - 缩略图显示
  - 选择状态管理
  - 按钮事件处理
  - 样式渲染

#### 预览组件
- **OriginalImageViewer**: 原图查看器
- **ThumbnailViewerDialog**: 缩略图浏览对话框
- **PreviewItemWidget**: 预览项组件

### 2. 业务逻辑层

#### APIManager (API管理器)
- **职责**: 统一管理API调用
- **主要功能**:
  - 搜索请求管理
  - 工作线程管理
  - 请求排队和调度
  - 错误处理和重试

#### ImageDownloadManager (下载管理器)
- **职责**: 管理图片下载任务
- **主要功能**:
  - 下载队列管理
  - 并发控制
  - 进度跟踪
  - 暂停/恢复/取消

### 3. 数据层

#### WebScraper (网络爬虫核心)
- **职责**: 网络数据获取和解析
- **主要功能**:
  - HTTP会话管理
  - 搜索请求处理
  - HTML内容解析
  - 数据结构化

### 4. 多线程工作层

#### BaseWorker (基础工作线程)
- **职责**: 提供线程基础功能
- **主要功能**:
  - 线程生命周期管理
  - 取消操作支持
  - 错误信号发送
  - 统一的线程接口

#### 具体工作线程
- **SearchWorker**: 搜索功能实现
- **PageFetchWorker**: 分页数据获取
- **AllPagesFetchWorker**: 全页面批量获取
- **GalleryWorker**: 图片集详情处理
- **ThumbnailWorker**: 缩略图生成
- **ImageLoadWorker**: 图片加载
- **DownloadWorker**: 图片下载
- **FileDownloadWorker**: 文件下载

## 设计模式应用

### 1. 观察者模式
- **应用场景**: Qt信号槽机制
- **优势**: 解耦GUI和业务逻辑，实现异步通信

### 2. 工厂模式
- **应用场景**: 工作线程创建
- **优势**: 统一线程创建接口，便于管理

### 3. 策略模式
- **应用场景**: 不同类型的爬虫任务
- **优势**: 灵活处理不同的爬虫策略

### 4. 单例模式
- **应用场景**: WebScraper静态方法
- **优势**: 全局统一的网络请求处理

## 并发设计

### 1. 线程模型
- **主线程**: GUI事件处理
- **工作线程**: 网络请求和数据处理
- **下载线程**: 文件下载操作

### 2. 同步机制
- **信号槽**: 线程间通信
- **原子操作**: 状态标志管理
- **队列**: 任务排队处理

### 3. 资源管理
- **线程池**: 控制并发数量
- **内存管理**: 及时释放资源
- **网络连接**: 复用HTTP会话

## 错误处理机制

### 1. 异常分类
- **网络异常**: 连接超时、服务器错误
- **解析异常**: HTML结构变化、数据格式错误
- **文件异常**: 磁盘空间不足、权限问题
- **用户异常**: 输入验证、操作冲突

### 2. 处理策略
- **重试机制**: 网络请求自动重试
- **降级处理**: 部分功能失败时的备选方案
- **用户反馈**: 友好的错误提示
- **日志记录**: 详细的错误日志

### 3. 恢复机制
- **状态恢复**: 从错误状态中恢复
- **数据恢复**: 未完成任务的恢复
- **用户操作**: 允许用户手动重试

## 性能优化

### 1. 网络优化
- **连接复用**: 使用Session复用连接
- **并发控制**: 限制同时请求数量
- **超时设置**: 合理的超时时间
- **缓存策略**: 避免重复请求

### 2. 内存优化
- **对象复用**: 重用UI组件
- **及时释放**: 不再使用的对象及时释放
- **图片优化**: 缩略图尺寸控制
- **垃圾回收**: 配合Python垃圾回收

### 3. UI优化
- **懒加载**: 按需加载内容
- **虚拟滚动**: 大量数据的高效显示
- **异步更新**: 不阻塞主线程
- **缓存渲染**: 减少重复渲染

## 扩展性设计

### 1. 插件机制
- **接口定义**: 标准的插件接口
- **动态加载**: 运行时加载插件
- **配置管理**: 插件配置和管理

### 2. 配置系统
- **分层配置**: 系统默认、用户自定义
- **热更新**: 无需重启的配置更新
- **格式支持**: 多种配置文件格式

### 3. 多站点支持
- **抽象接口**: 统一的站点接口
- **适配器模式**: 不同站点的适配器
- **配置驱动**: 通过配置添加新站点

## 安全性考虑

### 1. 输入验证
- **URL验证**: 确保URL格式正确
- **路径验证**: 防止路径遍历攻击
- **参数验证**: 检查所有输入参数

### 2. 网络安全
- **HTTPS支持**: 优先使用HTTPS
- **证书验证**: 验证服务器证书
- **请求头伪装**: 避免被识别为爬虫

### 3. 数据安全
- **敏感数据**: 不存储敏感信息
- **临时文件**: 及时清理临时文件
- **权限控制**: 最小权限原则

## 测试策略

### 1. 单元测试
- **核心逻辑**: 测试关键业务逻辑
- **工具函数**: 测试工具函数
- **边界条件**: 测试边界情况

### 2. 集成测试
- **组件交互**: 测试组件间交互
- **数据流**: 测试数据流转
- **异常处理**: 测试异常情况

### 3. 用户测试
- **功能测试**: 测试所有功能
- **性能测试**: 测试性能表现
- **兼容性测试**: 测试平台兼容性

## 部署和维护

### 1. 构建流程
- **自动化构建**: GitHub Actions自动构建
- **多平台支持**: 同时构建多个平台
- **版本管理**: 基于Git标签的版本管理

### 2. 发布策略
- **渐进发布**: 逐步推广新版本
- **回滚机制**: 快速回滚到稳定版本
- **用户反馈**: 收集用户反馈

### 3. 维护计划
- **定期更新**: 定期更新依赖库
- **安全修复**: 及时修复安全问题
- **功能改进**: 根据用户需求改进功能

## 总结

Photograph项目采用了清晰的分层架构，合理的设计模式，以及完善的错误处理机制。整个系统具有良好的扩展性、可维护性和性能表现。通过多线程设计实现了良好的用户体验，通过模块化设计实现了代码的可复用性。这是一个技术实现优秀、架构设计合理的开源项目。